---
title: Path-Based Multi-Tenancy
description: Migration from subdomain-based to path-based tenant isolation.
---

This document describes the migration from subdomain-based tenant isolation (e.g., `tavern.localhost:3002`) to path-based tenant isolation (e.g., `localhost:3002/tavern/...`), similar to how Shortcut handles tenancy.

## Motivation

Subdomain-based tenancy required complex DNS configuration for deployments (e.g., wildcard subdomains in Coolify). Path-based tenancy simplifies deployment while maintaining the same security guarantees.

## Architecture Changes

### Frontend Changes

1. **Route Structure**: All routes are now nested under `/$tenant`:
   - `/tavern/` - tenant index
   - `/tavern/r/ticket/create` - resource operations
   - `/tavern/signin` - authentication

2. **TenantContext**: A React context provides the current tenant slug to components:
   ```typescript
   export function useTenant(): TenantContext {
     const context = useContext(TenantContextValue);
     if (!context) {
       throw new Error("useTenant must be used within /$tenant route");
     }
     return context;
   }
   ```

### Backend Changes

1. **Tenant Identification**: The backend no longer extracts tenant from the Host header. Instead:
   - Provided in the login request body (for initial authentication)
   - Embedded in the JWT token (for subsequent requests)

2. **Middleware Chain**:
   ```typescript
   app.use("*", createTenantMiddleware());
   app.use("*", createAuthMiddleware(...));
   app.use("*", createPostAuthTenantMiddleware());
   ```

## Critical Implementation Details

### Cookie Configuration for Cross-Origin Requests

When frontend and backend run on different ports:

```typescript
setTokenInResponse(ctx: Context, token: string): void {
  ctx.header(
    "Set-Cookie",
    `${COOKIE_NAME}=${token}; HttpOnly; Path=/; SameSite=None; Secure; Max-Age=3600`,
  );
}
```

**Key settings:**
- `SameSite=None`: Required for cross-origin requests
- `Secure`: Required when `SameSite=None`
- `HttpOnly`: Prevents JavaScript access (XSS protection)

### RLS Context Timing Issue

**Problem**: With subdomain tenancy, RLS context was set from the Host header *before* authentication. With path-based tenancy, the tenant comes from the JWT token.

```
Subdomain flow:
1. Tenant middleware → Extract from Host → SET RLS
2. Auth middleware → Verify JWT (RLS already set!)

Path-based flow:
1. Tenant middleware → No tenant available yet
2. Auth middleware → Verify JWT (RLS NOT set!)
3. Post-auth middleware → Set RLS from user.tenantId
```

**Solution**: The `verifyToken()` method must use `getAdminDb()` (bypasses RLS) instead of `getDb()` when looking up users during authentication.

## File Changes Summary

### Frontend
- `src/context/TenantContext.tsx` - New file for tenant context
- `src/routes/root.tsx` - Added tenant route
- `src/routes/routes.ts` - Nested all routes under `tenantRoute`
- `src/routes/signin/signin-screen.tsx` - Passes tenant to login

### Backend
- `src/auth/NubaseBackendAuthController.ts` - Updated cookie settings
- `src/middleware/tenant-middleware.ts` - Added post-auth middleware
- `src/api/routes/auth.ts` - Get tenant from request body

## Testing

After making these changes:
1. Restart both frontend and backend servers
2. Clear browser cookies for localhost
3. Navigate to `http://localhost:3002/tavern`
4. Login should work and subsequent API requests should be authenticated

## Debugging Tips

Add logging to trace issues:

```typescript
console.info(`[Auth] ${c.req.method} ${c.req.path}`);
console.info(`[Auth] Token extracted: ${token ? "yes" : "no"}`);
console.info(`[Auth] Token verification: ${result.valid ? "valid" : result.error}`);
```

Common issues:
- **"User not found"**: Check if `verifyToken` is using `getAdminDb()`
- **401 Unauthorized**: Check cookie settings (`SameSite=None; Secure`)
- **Cookie not sent**: Ensure frontend uses `withCredentials: true`
